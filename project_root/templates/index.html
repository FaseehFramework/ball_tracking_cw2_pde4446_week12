<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERVO_VISION_V3</title>
    <style>
        :root {
            --bg: #f0f0f0;
            --hard-shadow: 5px 5px 0px #000000;
            --border: 3px solid #000000;
            --accent-yellow: #FFD700;
            --accent-red: #FF6B6B;
            --accent-teal: #4ECDC4;
            --accent-purple: #B19CD9;
            --text: #000000;
        }
        body { font-family: 'Courier New', monospace; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        
        /* HEADER */
        .header { background: var(--accent-teal); border: var(--border); padding: 10px 20px; margin-bottom: 20px; box-shadow: var(--hard-shadow); }
        .header h1 { margin: 0; text-transform: uppercase; font-size: 1.5rem; }

        /* TOP DASHBOARD (Hardware, Algo, Logs) */
        .top-dash { display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 20px; margin-bottom: 20px; }
        
        /* MAIN LAYOUT (Video Left, Tuner Right) */
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

        /* BOX UTILS */
        .box { background: white; border: var(--border); box-shadow: var(--hard-shadow); padding: 15px; display: flex; flex-direction: column; }
        h3 { border-bottom: 2px solid #000; padding-bottom: 5px; margin-top: 0; text-transform: uppercase; font-size: 1rem; }
        
        /* CONTROLS */
        button, input[type="text"] {
            font-family: inherit; font-weight: bold; border: var(--border); background: white;
            padding: 8px; cursor: pointer; width: 100%; box-sizing: border-box; margin-bottom: 5px;
        }
        button:active { transform: translate(2px, 2px); box-shadow: none; }
        .btn-active { background: #000; color: #fff; }
        .btn-green { background: #90EE90; }
        .btn-red { background: var(--accent-red); color: white; }

        /* VIDEO FEED SPLIT */
        .video-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .video-container img { width: 100%; border: var(--border); display: block; background: #000; }
        .label-tag { background: black; color: white; padding: 2px 5px; font-size: 0.7rem; display: inline-block; margin-bottom: 5px; }

        /* SLIDERS */
        .slider-group { margin-bottom: 10px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 0.8em; font-weight: bold; }
        input[type=range] { width: 100%; height: 10px; background: #ddd; appearance: none; border: 2px solid black; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 15px; height: 15px; background: black; cursor: pointer; }

        /* PRESETS */
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .preset-slot { border: 2px dashed #000; padding: 5px; text-align: center; }
        .btn-tiny { font-size: 0.7em; padding: 2px; }

        /* LOGS */
        #logs { height: 80px; overflow-y: scroll; font-size: 0.7rem; border-top: 2px solid #eee; padding-top: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>SERVO_VISION_CONTROLLER_V3</h1>
    </div>

    <div class="top-dash">
        <div class="box">
            <h3>Hardware</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="com-port-input" value="{{ port }}" placeholder="COM9">
                <button onclick="setPort()" style="width:auto;">CONN</button>
            </div>
            <button id="track-btn" class="btn-green" onclick="toggleTracking()">STOP TRACKING</button>
        </div>

        <div class="box">
            <h3>Algorithm</h3>
            <div style="display:flex; gap:5px;">
                <button id="btn-hsv" class="btn-active" onclick="setMode('HSV')">HSV</button>
                <button id="btn-yolo" onclick="setMode('YOLO')">YOLO</button>
            </div>
        </div>

        <div class="box">
            <h3>System Logs</h3>
            <div id="logs"></div>
        </div>
    </div>

    <div class="main-grid">
        
        <div class="box" style="background:var(--accent-yellow);">
            <h3>Vision Feed</h3>
            <div class="video-row">
                <div class="video-container">
                    <span class="label-tag">LIVE INPUT</span>
                    <img src="{{ url_for('video_feed_main') }}" alt="Live">
                </div>
                <div class="video-container">
                    <span class="label-tag">MASK / DEBUG</span>
                    <img src="{{ url_for('video_feed_mask') }}" alt="Mask">
                </div>
            </div>
        </div>

        <div class="box" id="tuning-panel">
            <h3>HSV Calibration</h3>
            
            <div id="sliders-container">
                <div class="slider-group">
                    <div class="slider-label"><span>H Min</span><span id="val-h_min">{{ hsv.h_min }}</span></div>
                    <input type="range" min="0" max="179" value="{{ hsv.h_min }}" oninput="updateHSV('h_min', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label"><span>S Min</span><span id="val-s_min">{{ hsv.s_min }}</span></div>
                    <input type="range" min="0" max="255" value="{{ hsv.s_min }}" oninput="updateHSV('s_min', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label"><span>V Min</span><span id="val-v_min">{{ hsv.v_min }}</span></div>
                    <input type="range" min="0" max="255" value="{{ hsv.v_min }}" oninput="updateHSV('v_min', this.value)">
                </div>
                <hr style="border:1px dashed #ccc;">
                <div class="slider-group">
                    <div class="slider-label"><span>H Max</span><span id="val-h_max">{{ hsv.h_max }}</span></div>
                    <input type="range" min="0" max="179" value="{{ hsv.h_max }}" oninput="updateHSV('h_max', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label"><span>S Max</span><span id="val-s_max">{{ hsv.s_max }}</span></div>
                    <input type="range" min="0" max="255" value="{{ hsv.s_max }}" oninput="updateHSV('s_max', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label"><span>V Max</span><span id="val-v_max">{{ hsv.v_max }}</span></div>
                    <input type="range" min="0" max="255" value="{{ hsv.v_max }}" oninput="updateHSV('v_max', this.value)">
                </div>
            </div>

            <br>
            <h3>Presets</h3>
            <div class="preset-grid">
                {% for i in range(4) %}
                <div class="preset-slot">
                    <div style="font-size:0.7rem; font-weight:bold; margin-bottom:3px;">SLOT {{i+1}}</div>
                    <button class="btn-tiny" onclick="savePreset({{i}})">SAVE</button>
                    <button class="btn-tiny" style="background:var(--accent-teal)" onclick="loadPreset({{i}})">LOAD</button>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>

    <script>
        let trackingActive = false;

        function log(msg) {
            const d = document.getElementById('logs');
            const t = new Date().toLocaleTimeString();
            d.innerHTML = `[${t}] ${msg}<br>` + d.innerHTML;
        }

        function updateHSV(key, val) {
            document.getElementById(`val-${key}`).innerText = val;
            fetch('/update_hsv', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({key: key, value: parseInt(val)})
            });
        }

        function setMode(mode) {
            fetch('/switch_mode', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({mode: mode})
            });
            
            document.getElementById('btn-hsv').className = mode==='HSV' ? 'btn-active' : '';
            document.getElementById('btn-yolo').className = mode==='YOLO' ? 'btn-active' : '';

            // Hide/Show Tuner based on mode
            const opacity = (mode === 'HSV') ? '1' : '0.3';
            const pointer = (mode === 'HSV') ? 'auto' : 'none';
            const panel = document.getElementById('tuning-panel');
            panel.style.opacity = opacity;
            panel.style.pointerEvents = pointer;
            
            log(`Switched to ${mode}`);
        }

        function toggleTracking() {
            trackingActive = !trackingActive;
            const btn = document.getElementById('track-btn');
            btn.innerText = trackingActive ? "STOP TRACKING" : "START TRACKING";
            btn.className = trackingActive ? "btn-green" : "btn-red";
            
            fetch('/toggle_tracking', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({active: trackingActive})
            });
        }

        function setPort() {
            const p = document.getElementById('com-port-input').value;
            fetch('/set_port', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({port: p})
            })
            .then(r => r.json())
            .then(d => log(d.success ? `Connected ${p}` : `Err: ${d.msg}`));
        }

        function savePreset(slot) {
            const name = prompt("Name this preset:", "New Color");
            if(!name) return;
            fetch('/preset', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'save', slot: slot, name: name})
            }).then(() => log(`Saved Slot ${slot+1}`));
        }

        function loadPreset(slot) {
            fetch('/preset', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'load', slot: slot})
            })
            .then(r => r.json())
            .then(d => {
                if(d.success) {
                    log(`Loaded Slot ${slot+1}`);
                    for (const [k, v] of Object.entries(d.values)) {
                        const el = document.querySelector(`input[oninput="updateHSV('${k}', this.value)"]`);
                        if(el) { el.value = v; document.getElementById(`val-${k}`).innerText = v; }
                    }
                }
            });
        }
        
        // Init Log
        log("System Ready.");
    </script>
</body>
</html>